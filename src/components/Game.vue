<template>
  <div v-if="visible" id="game">
    <h1>Game</h1>
    <div class="game-area">
      <canvas id="myCanvas" width="600" height="400" style="border:1px solid #d3d3d3;">
        Your browser does not support the HTML5 canvas tag.
      </canvas>
      <p>
        <span v-show="started && ended">Game ended, </span>Coins earned: {{coinsEarned}}
      </p>
      <button v-on:click="start()" :disabled="started">{{startBtnLabel}}</button>
      <button v-on:click="restart()">Restart</button>
      <div id="message_txt" style="display:block;">OUTBOUND RANGERS</div>
      <div id="score_txt" style="display:block;">Marks：0</div>
      <div id="coins_txt" style="display:block;">Coins：0</div>
      <div id="bullet_txt" style="display:block;">bullets：10</div>
    </div>

  </div>
</template>

<script>
import Obj from '@/components/obj'
import Coin from '@/components/coin'
import Bullet from '@/components/bullet'

export default {
  name: "Game",
  props:{
    visible: {
      type: Boolean,
      default: true
    },
    user:{
      default: {
        userID: "",
        password: "",
        lastActiveTime: "",
        highestScore: 0,
        accumulatedScore: 0,
        coins: 0,
        avatar: "./assets/avatar/default.png",
        skin: "./assets/skin/default.png",
        friendsID: []
      }
    }
  },
  data() {
    return {
      started: false,
      ended: false,
      coinsEarned: 0,
      startBtnLabel: 'Start',
    }
  },
  methods: {
    exit() {
      console.log("Exited: " + this.$options.name)
      this.$emit("exit", this.$options.name, "MainMenu")
    },
    start(){
      this.started = true
      this.ended = false
      this.startBtnLabel = 'Game Started'
		},
    regenerate(){
      if (this.started == true && this.coinsEarned < 10) {
        this.coinsEarned += 1
      } else {
        this.ended = true;
      }
    },
    restart() {
      this.startBtnLabel = 'Start'
      this.started = false
      this.ended = false
      this.coinsEarned = 0
    },
    imagePath(path) {
      if (!path) {
        path = "avatar_default.png";
      }
      return require('../assets/' + path);
    }
    /*component(width, height, color, x, y) {
      this.width = width;
      this.height = height;
      this.x = x;
      this.y = y;
      this.update = function() {
        ctx = myGameArea.context;
      }
    }*/
  },
  mounted() {
    /*this.interval = setInterval(this.regenerate, 1000);
    this.canvas = document.getElementById("myCanvas");
    var ctx = this.canvas.getContext("2d");
    ctx.fillStyle = "#AAAAAA";
    ctx.fillRect(500, 50, 50, 50);*/	
    var canvas = document.getElementById("myCanvas");
    var context = canvas.getContext("2d");
    document.addEventListener("keydown", onkeydown);
    document.addEventListener("keydown", onkeyup);

    // create image object
    var imageHero = new Image(75, 75);
    var imageCoin = new Image(50, 50);
    var imageMon = new Image(50, 50);
    var imageBul = new Image(50, 50);
    
    var enemyArray=[];
    var bulletArray = [];
    var coinArray = [];

    var floor = canvas.height - 75;
    var score = 0;
    var coingett = 0;
    var maxbullet = 10;
    var curbullet = 10;
    var gameOver = false;
    var hero;

    var bullet_txt = document.getElementById("bullet_txt");
    var message_txt = document.getElementById("message_txt");
    var coins_txt = document.getElementById("coins_txt");
    var score_txt = document.getElementById("score_txt");

    // bullet interval
    setInterval(function () {
      if(curbullet < maxbullet) {
        curbullet += 1;
        bullet_txt.innerHTML = "Bullet：" + curbullet + "";
      }
    },800);
    
    // load image src
    imageHero.src = this.imagePath("kitty.svg");
    imageHero.onload = function() {};
    imageCoin.src = this.imagePath("coin.svg");
    imageBul.src = this.imagePath("bullet.svg");
    imageBul.onload = function() {};
    imageMon.src = this.imagePath("monster.svg");
    imageMon.onload = function() {
        hero = new Obj(imageHero, 20, floor, 1);
        //create a monster in depending on the score
        var obj_interval = setInterval(function() {
          enemyArray.push(new Obj(imageMon, canvas.width, floor/2 , 1));
        }, 2500); 
        // coin interval
        setInterval(function() {
          coinArray.push(new Coin(imageCoin, canvas.width, floor*Math.random() , 1));
        }, 3000); 
        setInterval(function () {
          context.clearRect(0, 0, canvas.width, canvas.height);
          //draw hero
          if(!gameOver) {
            hero.draw_me(context, floor);
          }
          //draw enemy
          for (var i = enemyArray.length - 1; i >= 0; i--) {
              enemyArray[i].draw_enemy(context, floor);
          }
          //draw coins
          for (i = coinArray.length - 1; i >= 0; i--) {
              coinArray[i].draw(context);
          }			
          //draw bullets
          for (i = bulletArray.length - 1; i >= 0; i--) {
              bulletArray[i].draw(context);
          }
          //collison test
          for (i = enemyArray.length - 1; i >= 0; i--) {
            var enemy1=enemyArray[i];
            if (enemy1!=null && hero!=null && hero.hitTestObject(enemy1))
            {
                clearInterval(obj_interval);//clean the interval and no more enemy 
                enemyArray.splice(i, 1); //clear the enemy				   
                
                message_txt.innerHTML="Game Over";
                gameOver = true;				   
            }
          }
          for (i = coinArray.length - 1; i >= 0; i--) {
            var co=coinArray[i];
            if (co!=null && hero!=null && hero.hitTestObject(co))
            {
              coingett+=1;
              coinArray.splice(i, 1);
              coins_txt.innerHTML="coins：" + coingett + "";
              
            }
          }
			
          //judge bullet hit enemy
          for (var j = bulletArray.length - 1; j >= 0; j--) {
            var bullet1 = bulletArray[j];			
            for (i = enemyArray.length - 1; i >= 0; i--) {
              enemy1 = enemyArray[i];
              if (enemy1 != null && bullet1 != null && bullet1.hitTestObject(enemy1))//hited!
              {
                enemyArray.splice(i, 1); //del enemy
                bulletArray.splice(i, 1); //del bullet

                message_txt.innerHTML = "Hitted!!! + 20";
                score += 20;
                score_txt.innerHTML = "score：" + score + "";			   
              }
            }
          }
        }, 1000 / 60);
    };

    function onkeydown(e) {
      // press z to shoot
      if (e.key == "z" && curbullet > 0) {
        bulletArray.push(new Bullet(imageBul, hero.x+50, hero.y));
        curbullet--;
        bullet_txt.innerHTML = "Bullet：" + curbullet + "";
      }
      if (e.keyCode==32 ) {// press space to jump
        hero.move(0,-200);
      }
    }
  }
}
</script>

<style scoped>
div.game-area {
  width: 600px;
  display: block;
  margin: auto;
}

canvas { 
  background:url("../assets/game_bg.png");
  background-size: 100% 100%;
}

</style>