<!DOCTYPE html>
<html>
<head>
    <title>Game</title>
    <meta charset="utf-8">
</head>
<body>
<canvas id="myCanvas" width="320" height="480" style="border:solid">
    
</canvas>
<div id="message_txt" style="display:block;">OUTBOUND RANGERS</div>
<div id="score_txt" style="display:block;">Marks：0</div>
<script type="text/javascript">

    var canvas = document.getElementById("myCanvas");
    var context = canvas.getContext("2d");
	document.addEventListener("keydown", onkeydown);
	document.addEventListener("keydown", onkeyup);
	var obj = function (image, x, y, n) {
	    this.image = image;
	    this.x = x;
	    this.y = y;
	    this.originX = x;
	    this.originY = y;
	    this.width = image.width / n;
	    this.height = image.height;
	    this.isCaught = false;
	    this.frm = 0;
	    this.dis = 0;
	    this.n = n;
	};
    obj.prototype.getCaught = function (bool) {
        this.isCaught = bool;
        if (bool == false) {
            this.originX = 0;
            this.originY = this.y;
        }
    };
    obj.prototype.testPoint = function (x, y) {
        var betweenX = (x >= 0) && (x <= 1500);
        var betweenY = (y >= 0) && (y <= 500);
        return betweenX && betweenY;
    };

    obj.prototype.move = function (dx, dy) {
        this.x += dx;
		if(this.y +dy > 100){
			this.y += dy;
		}
    };
	obj.prototype.Y = function ( ) {
        return this.y;
    };
	//draw enemy
    obj.prototype.draw_enemy = function (ctx) {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.drawImage(this.image, this.frm *this.width, 0 , this.width, this.height, 0, 0, this.width, this.height);
        ctx.restore();
	    this.x=this.x-2;
        this.y = this.originX + 50 * Math.sin(Math.PI / 100 * this.x);
        this.dis++;

    };
	//draw me
    obj.prototype.draw_me = function (ctx) {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.drawImage(this.image, this.frm *this.width, 0 , this.width, this.height, 0, 0, this.width, this.height);
        ctx.restore();
        this.dis++;
		if(this.y<400){
		this.y=this.y+1
		}

    };
	// test the collison between the obj
	obj.prototype.hitTestObject = function (obj) {
		if(isColliding(this.x,this.y,this.width,this.height,
				obj.x,obj.y,obj.width,obj.height))
			return true;
		else
			return false;
	}
	
	function  isColliding( ax, ay, aw, ah,  bx,  by,  bw,  bh)
    { 
       if(ay > by + bh || by > ay + ah || ax > bx + bw || bx > ax + aw) 
         return false; 
       else
         return true; 
    } 

	
	//class obstuct not finished yet
	//class coins or reward not finished yet
	//class bullet
    var Bullet = function (image, x, y) {
        this.image = image;
        this.x = x;
        this.y = y;
        this.originX = x;
        this.originY = y;
        this.width = image.width;
        this.height = image.height ;
        this.isCaught = false;
        this.frm = 0;
        this.dis = 0;
    };
    Bullet.prototype.testPoint = function (x, y) {
        var betweenX = (x >= this.x) && (x <= this.x + this.width);
        var betweenY = (y >= this.y) && (y <= this.y + this.height);
        return betweenX && betweenY;
    };
    Bullet.prototype.move = function (dx, dy) {
        this.x += dx;
        this.y += dy;
    };
	Bullet.prototype.Y = function ( ) {
        return this.y;
    };
    Bullet.prototype.draw = function (ctx) {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.drawImage(this.image, this.frm *this.width, 0 , this.width, this.height, 0, 0, this.width, this.height);
        ctx.restore();
	    this.x=this.x+10;
        
    };	
	Bullet.prototype.hitTestObject = function (obj) {
		if(isColliding(this.x,this.y,this.width,this.height,
				obj.x,obj.y,obj.width,obj.height))//collison occurs 
			return true;
		else
			return false;
	
	}

    var isClicked = false;
    var objs=[];
    var bullets = [];

	var score=0;
	var overflag=false;//Game over judge
    var hero;
    var image = new Image();
    var image2 = new Image();
    var image3 = new Image();
    var image4 = new Image();
	var image5 = new Image();
    var background = new Image();
	var canvas = document.getElementById("myCanvas");
    background.src = "map_0.png"; //backgroundimgae
    image.src = "hero.png";//hero image
    image.onload = function () {

    };

    image3.src = "enemy.png";//enemy image
    image3.onload = function () {
        hero = new obj(image, 20, 400, 1)
        
        obj_interval=setInterval(function (){objs.push(new obj(image3, 300 , 20 * Math.random(), 1));}, 1000); //create a monster in 3s
        setInterval(function () {
            context.drawImage(background, 0, 0);
			if(!overflag)//if not gameover
				hero.draw_me(context);//draw hero
            //draw enemy
            for (var i = objs.length - 1; i >= 0; i--) {
                objs[i].draw_enemy(context);
            }
			//draw bullets
            for (var i = bullets.length - 1; i >= 0; i--) {
                    bullets[i].draw(context);
            }
			//collison test
			for (var i = objs.length - 1; i >= 0; i--) {
				e1=objs[i];
				if (e1!=null && hero!=null && hero.hitTestObject(e1))
				{
				   clearInterval(obj_interval);//clean the interval and no more enemy 
				   objs.splice(i, 1); //clear the enemy				   
				   
				   message_txt.innerHTML="Game Over";
				   overflag=true;				   
				}
			}
			
			//judge bullet hit enemy
			for (var j = bullets.length - 1; j >= 0; j--) {
				var b1=bullets[j];			
				for (var i = objs.length - 1; i >= 0; i--) {
					e1=objs[i];
					if (e1!=null && b1!=null && b1.hitTestObject(e1))//hited!
					{
					   objs.splice(i, 1); //del enemy
					   bullets.splice(i, 1); //del bullet
					   
		   
					   message_txt.innerHTML="Hited!!! +20";
					   score+=20;
					   score_txt.innerHTML="score："+score+"";			   
					}
				}
			}
        }, 1000 / 60);
    };
	image4.src = "bullet.png";//
    image4.onload = function () {

    };

    function onkeydown(e) {
        if (e.key == "z" || e.key == "z") {//press z and shoot
            bullets.push(new Bullet(image4, hero.x, hero.y-36));//
        }else if (e.keyCode==32) {//press space to jump
            hero.move(0,-40);
        }else{
			hero.move(0,10);
		}
    }


</script>
</body>
</html>
